# 4.3 Tag Query Validation And Index Tuning

## Query Path Validated

Validated the `sort=count` path in `flaskmarks/api/tags.py` (`list_tags`), which:

1. Aggregates tag counts for a user via grouped SQL.
2. Applies SQL ordering (`count DESC`, `title ASC`) before pagination.

Representative SQL shape used for validation:

```sql
SELECT t.id, t.title, c.mark_count
FROM tags AS t
JOIN (
  SELECT t2.id AS tag_id, COUNT(m.id) AS mark_count
  FROM tags AS t2
  JOIN marks_tags AS mt ON t2.id = mt.right_id
  JOIN marks AS m ON m.id = mt.left_id
  WHERE m.owner_id = 1
  GROUP BY t2.id
) AS c ON t.id = c.tag_id
WHERE EXISTS (
  SELECT 1
  FROM marks_tags AS mt2
  JOIN marks AS m2 ON m2.id = mt2.left_id
  WHERE mt2.right_id = t.id
    AND m2.owner_id = 1
)
ORDER BY c.mark_count DESC, t.title ASC
LIMIT 50 OFFSET 0;
```

## Representative Data Setup

SQLite dataset used for perf-oriented sanity:

- `tags`: 4,000 rows
- `marks`: 60,000 rows across 12 owners
- `marks_tags`: 180,000 rows (3 tags per mark)

## Index Changes Applied

- `marks(owner_id)` via `ix_marks_owner_id`
- `marks_tags(left_id)` via `ix_marks_tags_left_id`
- `marks_tags(right_id)` via `ix_marks_tags_right_id`
- `marks_tags(left_id, right_id)` via `ix_marks_tags_left_right`

## Query Plan Comparison

Baseline (no indexes):

```text
|--CO-ROUTINE c
|  |--SCAN mt
...
|--CORRELATED SCALAR SUBQUERY 2
|  |--SCAN mt2
|  `--SEARCH m2 USING INTEGER PRIMARY KEY (rowid=?)
```

Indexed:

```text
|--CO-ROUTINE c
|  |--SEARCH m USING COVERING INDEX ix_marks_owner_id (owner_id=?)
|  |--SEARCH mt USING COVERING INDEX ix_marks_tags_left_right (left_id=?)
...
|--CORRELATED SCALAR SUBQUERY 2
|  |--SEARCH mt2 USING INDEX ix_marks_tags_right_id (right_id=?)
|  `--SEARCH m2 USING COVERING INDEX ix_marks_owner_id (owner_id=? AND rowid=?)
```

Result: full scans on `marks_tags` in this query path were replaced by index lookups on both aggregation and correlated existence checks.

## Perf-Oriented Sanity Check

30 executions of the same paginated count-sort query:

- Baseline: `14.239s total`
- Indexed: `0.762s total`

Outputs were identical for the full 50-row page (`results_identical=yes`).
