{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% block content %}
    <div class="container-fluid p-0">
        <div class="delicious-layout">
            <!-- Left Sidebar -->
            <div class="sidebar-left sidebar">
                <div class="user-info">
                    <h2>{{ g.user.username }}</h2>
                    <div class="user-tabs">
                        <a href="{{ url_for('marks.allmarks') }}">Bookmarks</a> |
                        <a href="{{ url_for('tags.cloud') }}">Tags</a> |
                        <a href="{{ url_for('profile.userprofile') }}" class="fw-bold">Profile</a>
                    </div>
                </div>
                <div class="filter-section">
                    <h4>Actions</h4>
                    <a href="{{ url_for('marks.import_marks') }}">Import marks</a>
                    <a href="{{ url_for('marks.export_marks') }}">Export marks</a>
                    <a href="{{ url_for('auth.logout') }}">Logout</a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <div class="content-header">
                    <span>Profile - {{ g.user.username }}</span>
                </div>
                <div class="p-3">
                    {% include "flash.html" %}
                    
                    <div class="mb-4">
                        <h4 style="font-size: 13px; font-weight: bold; margin-bottom: 10px;">Statistics</h4>
                        <div class="tag-list">
                            <div class="tag-item">
                                <span>Total marks:</span>
                                <span class="tag-count">{{ bc+fc+yc }}</span>
                            </div>
                            <div class="tag-item">
                                <span>Bookmarks:</span>
                                <span class="tag-count">{{ bc }}</span>
                            </div>
                            <div class="tag-item">
                                <span>Feeds:</span>
                                <span class="tag-count">{{ fc }}</span>
                            </div>
                            <div class="tag-item">
                                <span>YouTube:</span>
                                <span class="tag-count">{{ yc }}</span>
                            </div>
                            {% if lcm %}
                            <div class="tag-item">
                                <span>Last created:</span>
                                <span class="tag-count">{{ lcm.created }}</span>
                            </div>
                            {% endif %}
                            <div class="tag-item">
                                <span>Last login:</span>
                                <span class="tag-count">{{ g.user.last_logged }}</span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-4">
                        <h4 style="font-size: 13px; font-weight: bold; margin-bottom: 10px;">API Access</h4>
                        <p style="font-size: 11px; color: var(--text-secondary);">Use this token to access the REST API from external applications.</p>
                        
                        <div class="mb-3">
                            <label style="font-size: 11px;"><strong>API Token</strong> (valid for {{ token_validity_hours }} hours)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="api-token" value="{{ api_token }}" readonly>
                                <button class="btn btn-primary" type="button" onclick="copyToClipboard('api-token')">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                            <p style="font-size: 10px; color: var(--text-muted); margin-top: 5px;">
                                Usage: <code>Authorization: Bearer &lt;token&gt;</code>
                            </p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 style="font-size: 13px; font-weight: bold; margin-bottom: 10px;">Bookmarklet</h4>
                        <p style="font-size: 11px;">Drag this button to your bookmarks bar:</p>
                        <p>
                            <a class="btn btn-primary btn-sm" href="{{ bookmarklet }}" onclick="alert('Drag this button to your bookmarks bar!'); return false;">
                                <i class="bi bi-bookmark-plus"></i> Save to {{ config['SITE_TITLE'] }}
                            </a>
                        </p>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" id="bookmarklet-code" value="{{ bookmarklet }}" readonly>
                            <button class="btn btn-primary" type="button" onclick="copyToClipboard('bookmarklet-code')">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 style="font-size: 13px; font-weight: bold; margin-bottom: 10px;">Browser Extension</h4>
                        <p style="font-size: 11px;">Install the browser extension to quickly save bookmarks.</p>
                        <a href="{{ url_for('profile.download_firefox_extension') }}" class="btn btn-primary btn-sm">
                            <i class="bi bi-download"></i> Download for Firefox
                        </a>
                        <p style="font-size: 10px; color: var(--text-muted); margin-top: 10px;">
                            Note: Requires manual installation via <code>about:debugging</code>
                        </p>
                    </div>

                    <hr>

                    <div class="mb-4">
                        <h4 style="font-size: 13px; font-weight: bold; margin-bottom: 10px;">Profile Settings</h4>
                        {{ wtf.quick_form(form, button_map={'submit_button': 'primary'}) }}
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar -->
            <div class="sidebar-right tags-sidebar">
                <h3>API Endpoints</h3>
                <div class="tag-list" style="font-size: 10px;">
                    <p><strong>Base:</strong> <code>{{ server_url }}/api/v1</code></p>
                    <div class="tag-item"><code>POST /quickadd</code></div>
                    <div class="tag-item"><code>GET /marks</code></div>
                    <div class="tag-item"><code>POST /marks</code></div>
                    <div class="tag-item"><code>GET /marks/search</code></div>
                    <div class="tag-item"><code>GET /tags</code></div>
                    <div class="tag-item"><code>POST /auth/refresh</code></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    function copyToClipboard(elementId) {
        var copyText = document.getElementById(elementId);
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(copyText.value).then(function() {
                alert('Copied to clipboard!');
            });
        } else {
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }
    }
    </script>
{% endblock %}
